name: Continuous Deployment Workflow

on:
  workflow_run:
    workflows: ['Continuous Integration Workflow']
    types:
      - completed

jobs:
  release:
    runs-on: ubuntu-latest
    container:
      image: d3lta12/arm-build-tools
    # if: >
    #   github.event.workflow_run.conclusion == 'success' &&
    #   startsWith(github.event.workflow_run.ref, 'refs/tags/')
    
    steps:
      - name: Debug
        run: |
          echo "${{ github.event.workflow_run.conclusion }} ${{ github.event.workflow_run.ref }}" >> $GITHUB_OUTPUT
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      - name: Create pre-release
        if: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release create "$tag" \
              --title="${tag#v}" \
              --generate-notes \
              --latest=false
              --prerelease
      - name: Create release
        if: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release create "$tag" \
              --title="${tag#v}" \
              --generate-notes \
              --latest=true
      # TODO verify status checks
      # - name: Upload build
      #   uses: actions/upload-release-asset@v1
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./your_artifact.zip
      #     asset_name: your_artifact.zip
      #     asset_content_type: application/zip